doctype html

html
	head
		title Welcome #{username}
		meta(charset='utf-8')
		meta(name='description' content='exercise tracker profile')
		meta(http-equiv='X-UA-Compatible', content='IE-edge')
		meta(name='viewport', content='width=device-width, initial-scale=1')
		meta(http-equiv='Content-Language' content='en')
		script(src="https://momentjs.com/downloads/moment.min.js")
		script(src="https://cdn.jsdelivr.net/npm/chart.js@2.7.2/dist/Chart.bundle.min.js")
		script(src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js')
		script(src='https://code.jquery.com/ui/1.12.1/jquery-ui.js')
		
	body
	
		include ../includes/navbar.pug
		
		header
			h1 Hi, #{username}!		
		
		
		h2 New Entry
		
		form(id="exercise_form" action='/api/updatedata' method='put')
			label Choose the category of your exercise
			select(id="category" name="category" required)
				option(selected) aerobic
				option strength
				option flexibility
				option balance
			label Description of your exercise
			input(type='text' id="description" name='description' required)
			label Provide the duration of your exercise
			input(type='time' id='duration1' name='duration1' min="00:00" max="24:00" required)
			p to
			input(type='time' id='duration2' name='duration2' min="00:00" max="24:00" required)
			label Choose the date of your exercise
			input(type='text' id='datepicker' name="date" required)
			input(type='submit' name='submit' value='add new entry')

		h2 Progress Chart
		
		div(id="chartContainer")
			canvas(id="progressChart" width="400" height="400")
			ul#buttonHolder
				button(id="aerobicChart") Aerobic
				button(id="strengthChart") Strength
				button(id="flexibilityChart") Flexibility
				button(id="balanceChart") Balance
		
		div#journal
			for n, i in exercise_data
				div.dataContainer
					p=moment(n.date).format('MM/DD/YYYY')
					p=n.description
					p=moment.duration(n.duration, 'seconds').humanize()
					p=n.category
		
		- var x = 0;
		
		ul
			while x < max
				-x++
				a(id=x+"get")=x
	script.
		$(document).ready(function() {
		
			//creating the chart
			$.ajax({
				type: 'GET',
				url: '/api/getchart',
				data: {category:"aerobic"},
				success: function(chartData){
					var ctx = document.getElementById('progressChart').getContext('2d');
					chartData.options.scales = {
						yAxes: [{
							ticks: {
								callback: function(value, index, values){
									return value + ' min.';
								}
							}
						}]
					}
					var chart = new Chart(ctx, chartData);
				},
				failure: function(data){
					console.log(data);
					//delete canvas and replace it with a text saying "no entries"
				}
			});
		
			
			//getting a new page
			for(let i = 0; i < #{max}; i++){
				$((i + 1)+"get").click(function(e){
					$.ajax({
						type: 'GET',
						url: '/api/getdata',
						data: i + 1,
						success: function(data){
							var html = [];
							data.forEach((ele) => {
								html.push('<div class="dataContainer">');
								html.push('<p>'+ele.data+'</p><p>'+ele.description+'</p>');
								html.push('<p>'+ele.duration+'</p><p>'+ele.category+'</p></div>');
							});
							$('#journal').html(html.join(''));
						},
						error: function(data){
							alert(data)
						}
					});
				})
			}
			
			//adding buttons to change chart
			var buttons = [
				"#aerobicChart",
				"#strengthChart",
				"#flexibilityChart",
				"#balanceChart"			
			];
			for(let i = 0; i < buttons.length; i++){
				(function (button){

					$(button).click(function(e){
						$.ajax({
							type: 'GET',
							url: '/api/getchart',
							data: $(button).text().toLowerCase(),
							success: function(data){
								chart.data = data.data;
								chart.options = data.option;
								chart.update();
							},
							error: function(data){
								alert(data);
							}
						});
						e.preventDefault;
					});
				})(buttons[i]);
				
			}
			
			//date picker form entry
			$("#datepicker").datepicker();
			
			//add response to updating 			
			$("#exercise_form").submit(function(e){
				var time2 = document.getElementById('duration2').valueAsNumber;
				var time1 = document.getElementById('duration1').valueAsNumber;
				var timeDuration = (time2 - time1)/1000;
				if(timeDuration < 0){alert('The second time submission should be after the first!'); return;}

				var data = {
					category: $('#category').val(),
					date: $('#datepicker').val(),
					description: $('#description').val(),
					duration: timeDuration
				};
				
				$.ajax({
					type: "PUT",
					url: '/api/updatedata',
					data: data,
					success: function(data){
						alert('Your entry was successfully submitted')
					},
					error: function(data){console.log(data);alert(data)}
				});
				e.preventDefault();
			});
		});